stages:
  - test

image: ddev/ddev-webserver:latest

variables:
  DEBIAN_FRONTEND: "noninteractive"
  COMPOSER_CACHE_PATH_RELATIVE: ".composer/cache"
  YARN_CACHE_PATH_RELATIVE: ".yarn/cache"
  # Absolute cache paths outside of the DDEV web container.
  COMPOSER_CACHE_DIR_CI: "$CI_PROJECT_DIR/$COMPOSER_CACHE_PATH_RELATIVE"
  YARN_CACHE_DIR_CI: "$CI_PROJECT_DIR/$YARN_CACHE_PATH_RELATIVE"
  # Absolute cache paths inside the DDEV web container.
  COMPOSER_CACHE_DIR_CONTAINER: "/var/www/html/$COMPOSER_CACHE_PATH_RELATIVE"
  YARN_CACHE_DIR_CONTAINER: "/var/www/html/$YARN_CACHE_PATH_RELATIVE"
  # Allow service containers to see each other.
  #
  # @see https://docs.gitlab.com/ee/ci/services/#connecting-services
  FF_NETWORK_PER_BUILD: 'true'

cache:
  # Cache is per-branch.
  key: "$CI_BUILD_REF_NAME"
  paths:
    - "$COMPOSER_CACHE_DIR_CI"
    - "$YARN_CACHE_DIR_CI"

# Hidden job intended as a template for tests.
#
# @see https://docs.gitlab.com/ee/ci/yaml/yaml_optimization.html#anchors
.test-base: &test-base
  stage: test

  # Don't run on changes to these path patterns.
  #
  # @todo Port this to rules as 'except' is deprecated.
  #
  # @see https://docs.gitlab.com/ci/yaml/#only--except
  except:
    changes:
      # Not relevant for testing.
      - '**.md'
      # DigitalOcean stuff is not currently relevant to CI.
      - '/.apache/**'
      - '/.do/**'
      - '/.php/**'
      # Drupal config is not currently used for testing as that's all set up in
      # modules and in tests.
      - '/drupal_config/**'
      - '/drupal_private_files/**'
      # Drush config is not used for CI.
      - '/drush/**'
      # Ignore any changes in aggregated assets and public files directories.
      - '/web/assets/**'
      - '/web/sites/*/files/**'
      # Obvious reason is obvious.
      - '/.github/**'

  before_script:
    - composer install --no-progress
    - yarn install
    - yarn build:deploy

  artifacts:
    expire_in: 1 week
    expose_as: web
    when: always
    exclude:
    - ".git"
    - ".git/**/*"
    - "$CI_PROJECT_DIR/web/**/.git"
    - "$CI_PROJECT_DIR/web/**/.git/**/*"
    - vendor/**/.git
    - vendor/**/.git/**/*
    name: artifacts-$CI_PIPELINE_ID-$CI_JOB_NAME_SLUG
    paths:
    - "$CI_PROJECT_DIR"

test:phpunit:
  <<: *test-base
  script:
    - phpunit --group=omnipedia --verbose
