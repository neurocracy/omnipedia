From 81edf7d063d004399bcc644398f59ed6537fc0e5 Mon Sep 17 00:00:00 2001
From: Matei Stanca <i@ambientimpact.com>
Date: Mon, 17 Jan 2022 22:22:30 -0500
Subject: [PATCH] Trusted host check can now use Drupal\Core\Site\Settings

---
 src/CheckSettings/TrustedHostSettings.php |  1 +
 src/Checks/TrustedHosts.php               | 19 +++++++++++++++++--
 2 files changed, 18 insertions(+), 2 deletions(-)

diff --git a/src/CheckSettings/TrustedHostSettings.php b/src/CheckSettings/TrustedHostSettings.php
index feb95bb..eba869b 100644
--- a/src/CheckSettings/TrustedHostSettings.php
+++ b/src/CheckSettings/TrustedHostSettings.php
@@ -21,6 +21,7 @@ class TrustedHostSettings extends CheckSettings {
       '#options' => [
         'token' => t('Tokenize settings.php (recommended)'),
         'include' => t('Include settings.php'),
+        'settings_class' => t('Use Drupal\Core\Site\Settings'),
       ],
       '#default_value' => $this->get('method', 'token'),
     ];
diff --git a/src/Checks/TrustedHosts.php b/src/Checks/TrustedHosts.php
index 947f32d..c7a4644 100644
--- a/src/Checks/TrustedHosts.php
+++ b/src/Checks/TrustedHosts.php
@@ -3,6 +3,7 @@
 namespace Drupal\security_review\Checks;
 
 use Drupal\Core\Link;
+use Drupal\Core\Site\Settings;
 use Drupal\Core\Url;
 use Drupal\security_review\Check;
 use Drupal\security_review\CheckResult;
@@ -90,8 +91,22 @@ class TrustedHosts extends Check {
           }
         }
       }
-    }
-    else {
+
+    } else if ($this->settings()->get('method', 'token') === 'settings_class') {
+
+      if (!empty(Settings::get('trusted_host_patterns'))) {
+        $trusted_host_patterns_set = TRUE;
+        $result = CheckResult::SUCCESS;
+      }
+
+      global $base_url;
+
+      if (!empty($base_url)) {
+        $base_url_set = TRUE;
+        $result = CheckResult::SUCCESS;
+      }
+
+    } else {
       // Use inclusion.
       include $settings_php;
       $base_url_set = isset($base_url);
-- 
GitLab

